<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>SSE Snapshot + Deltas</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
  #items { padding-left: 1rem; }
  li { margin: .25rem 0; }
  form { margin-top: 1rem; display: flex; gap: .5rem; }
  input { flex: 1; padding: .5rem; }
  button { padding: .5rem .75rem; cursor: pointer; }
  .status { font-size: .9rem; opacity: .7; }
</style>
</head>
<body>
  <h1>SSE: snapshot + deltas</h1>
  <div class="status" id="status">connecting…</div>
  <ul id="items"></ul>

  <form id="form">
    <input id="text" placeholder="Add item…" required />
    <button type="submit">Add</button>
  </form>

<script>
  const itemsEl = document.getElementById('items');
  const statusEl = document.getElementById('status');

  // local state (authoritative view rendered in DOM)
  let items = [];

  function render() {
    itemsEl.innerHTML = '';
    for (const t of items) {
      const li = document.createElement('li');
      li.textContent = t;
      itemsEl.appendChild(li);
    }
  }

  // Connect SSE
  function connect() {
    const ev = new EventSource('/events');

    ev.addEventListener('open', () => statusEl.textContent = 'live ✅');
    ev.addEventListener('error', () => statusEl.textContent = 'disconnected, retrying…');

    // 1) Receive full snapshot first
    ev.addEventListener('snapshot', e => {
      items = JSON.parse(e.data);
      render();
    });

    // 2) Apply deltas
    ev.addEventListener('delta', e => {
      const msg = JSON.parse(e.data);
      switch (msg.type) {
        case 'Append':
          items.push(msg.payload);
          render();
          break;
        // Add Update/Remove handling here if you extend the protocol
      }
    });
  }
  connect();

  // Add new item (POST to server; all clients receive delta)
  document.getElementById('form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const text = document.getElementById('text').value.trim();
    if (!text) return;
    try {
      await fetch('/items', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ text }),
      });
      document.getElementById('text').value = '';
    } catch (err) {
      alert('Failed to add: ' + err);
    }
  });
</script>
</body>
</html>
