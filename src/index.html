<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>SSE Snapshot + Deltas</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <style>
            body {
                font-family:
                    system-ui,
                    -apple-system,
                    Segoe UI,
                    Roboto,
                    sans-serif;
                margin: 2rem;
            }
            #chat-container {
                border: 1px solid #ddd;
                border-radius: 8px;
                height: 400px;
                overflow-y: auto;
                padding: 1rem;
                background-color: #f9f9f9;
                margin: 1rem 0;
            }
            #items {
                list-style: none;
                padding: 0;
                margin: 0;
            }
            li {
                margin: 0.5rem 0;
                padding: 0.75rem;
                background-color: #fff;
                border-radius: 6px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                animation: fadeIn 0.3s ease-in;
            }
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            form {
                margin-top: 1rem;
                display: flex;
                gap: 0.5rem;
            }
            input {
                flex: 1;
                padding: 0.5rem;
            }
            button {
                padding: 0.5rem 0.75rem;
                cursor: pointer;
            }
            .status {
                font-size: 0.9rem;
                opacity: 0.7;
            }
        </style>
    </head>
    <body>
        <h1>SSE: snapshot + deltas</h1>
        <div class="status" id="status">connecting…</div>
        <div id="chat-container">
            <ul id="items"></ul>
        </div>

        <form id="form">
            <input id="text" placeholder="Add item…" required />
            <button type="submit">Add</button>
        </form>

        <script>
            const itemsEl = document.getElementById("items");
            const statusEl = document.getElementById("status");

            // local state (authoritative view rendered in DOM)
            let items = [];

            function render() {
                itemsEl.innerHTML = "";
                for (const t of items) {
                    const li = document.createElement("li");
                    li.textContent = t;
                    itemsEl.appendChild(li);
                }
                // Auto-scroll to bottom like a chat log
                const chatContainer = document.getElementById("chat-container");
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            // Connect SSE
            function connect() {
                const ev = new EventSource("/events");

                ev.addEventListener(
                    "open",
                    () => (statusEl.textContent = "live ✅"),
                );
                ev.addEventListener(
                    "error",
                    () => (statusEl.textContent = "disconnected, retrying…"),
                );

                // 1) Receive full snapshot first
                ev.addEventListener("snapshot", (e) => {
                    items = JSON.parse(e.data);
                    render();
                });

                // 2) Apply deltas
                ev.addEventListener("delta", (e) => {
                    const msg = JSON.parse(e.data);
                    switch (msg.type) {
                        case "Create":
                            items.push(msg.payload);
                            // For chat-like experience, add new item with animation
                            const li = document.createElement("li");
                            li.textContent = msg.payload;
                            itemsEl.appendChild(li);

                            // Auto-scroll to show new message
                            const chatContainer =
                                document.getElementById("chat-container");
                            chatContainer.scrollTop =
                                chatContainer.scrollHeight;
                            break;
                        // Add Update/Remove handling here if you extend the protocol
                    }
                });
            }
            connect();

            // Add new item (POST to server; all clients receive delta)
            document
                .getElementById("form")
                .addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const text = document.getElementById("text").value.trim();
                    if (!text) return;
                    try {
                        await fetch("/items", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ text }),
                        });
                        document.getElementById("text").value = "";
                    } catch (err) {
                        alert("Failed to add: " + err);
                    }
                });
        </script>
    </body>
</html>
